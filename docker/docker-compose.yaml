version: "3.9"

# Commands:
# docker compose up --build

# Properties description:
# https://kafka.apache.org/documentation/#configuration
# https://github.com/robcowart/docker_compose_cookbook/blob/master/STACKS/confluent_kafka/docker-compose.yml
# https://docs.confluent.io/platform/current/installation/docker/config-reference.html
services:

  zookeeper:
    image: confluentinc/cp-zookeeper:7.4.0
    hostname: zookeeper
    ports:
      - 2181:2181
    environment:
      # port where to listen for connections by kafka brokers
      ZOOKEEPER_CLIENT_PORT: 2181

      # basic zookeeper time unit used to regulate heartbeats and timeouts. For example, the minimum session timeout will be two ticks.
      ZOOKEEPER_TICK_TIME: 2000

  kafka_broker_1:
    image: confluentinc/cp-kafka:7.4.0
    hostname: broker1
    ports:
      - 9092:9092
      - 9998:9998
    depends_on:
      - zookeeper
    environment:
      KAFKA_JMX_PORT: 9998
      CONFLUENT_METRICS_REPORTER_BOOTSTRAP_SERVERS: broker1:29092
      CONFLUENT_METRICS_REPORTER_ZOOKEEPER_CONNECT: zookeeper:2181
      CONFLUENT_METRICS_REPORTER_TOPIC_REPLICAS: 1
      CONFLUENT_METRICS_ENABLE: 'false'

      # The broker id for this server which should be unique inside cluster.
      KAFKA_BROKER_ID: 1

      # Zookeeper connection string, can have multiple values - hostname1:port1,hostname2:port2
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181

      # Describes listeners, as possible interfaces which clients may use for connection to broker. These values will be published to Zookeeper for clients to use.
      # Here we have two listeners:
      # 1. 'broker1' listener for docker internal network, e.g. it's used by kafka-ui container and for communication between brokers
      # 2. 'localhost' listener for host network, which will be used outside of container, that's why we do port forwarding only for 9092
      # Detailed explanation - https://www.confluent.io/blog/kafka-listeners-explained/
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://broker1:29092, PLAINTEXT_HOST://localhost:9092

      # Defines key/value pairs for the security protocol to use per listener name
      # List of supported protocols - https://kafka.apache.org/24/javadoc/org/apache/kafka/common/security/auth/SecurityProtocol.html
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT

      # Name of the listener which will be used for internal communication between brokers
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT

      # The replication factor for the offsets topic "__consumer_offsets" which is used by consumers.
      # In case where kafka node goes down, consumers will be able to find information about offsets on other node.
      # Otherwise, consumers will lose track of where they are and may start read messages from start or only from new message (depending on the configuration).
      # Internal topic creation will fail until the cluster size meets this replication factor requirement.
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 2

  kafka_broker_2:
    image: confluentinc/cp-kafka:7.4.0
    hostname: broker2
    ports:
      - 9093:9093
      - 9999:9999
    depends_on:
      - zookeeper
    environment:
      KAFKA_JMX_PORT: 9999
      CONFLUENT_METRICS_REPORTER_BOOTSTRAP_SERVERS: broker2:29093
      CONFLUENT_METRICS_REPORTER_ZOOKEEPER_CONNECT: zookeeper:2181
      CONFLUENT_METRICS_REPORTER_TOPIC_REPLICAS: 1
      CONFLUENT_METRICS_ENABLE: 'false'

      KAFKA_BROKER_ID: 2
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://broker2:29093, PLAINTEXT_HOST://localhost:9093
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 2

  # https://github.com/provectus/kafka-ui
  kafka-ui:
    image: provectuslabs/kafka-ui:2ac8646769d10e69d972928b943c5bcc708ddc61
    ports:
      - 8090:8080
    restart: always
    environment:
      - KAFKA_CLUSTERS_0_NAME=local
      - KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS=broker1:29092,broker2:29093
      - KAFKA_CLUSTERS_0_ZOOKEEPER=zookeeper:2181

  # Monitoring
  prometheus:
    image: prom/prometheus:v2.34.0
    hostname: prometheus
    ports:
      - 9090:9090
    volumes:
      - ./etc/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
    command: "--config.file=/etc/prometheus/prometheus.yml"

  grafana:
    image: grafana/grafana:8.4.5
    hostname: grafana
    ports:
      - 3000:3000
    environment:
      GF_PATHS_DATA: /var/lib/grafana
      GF_SECURITY_ADMIN_PASSWORD: kafka
    volumes:
      - ./etc/grafana/provisioning:/etc/grafana/provisioning
      - ./var/lib/grafana/dashboards:/var/lib/grafana/dashboards
    depends_on:
      - prometheus

  jmx_exporter_kafka_broker_1:
    image: sscaling/jmx-prometheus-exporter
    hostname: exporter1
    ports:
      - 5556:5556
    environment:
      CONFIG_YML: /etc/jmx_exporter/config.yml
    volumes:
      - ./etc/jmx_exporter/config_kafka_broker_1.yml:/etc/jmx_exporter/config.yml
    depends_on:
      - kafka_broker_1

  jmx_exporter_kafka_broker_2:
    image: sscaling/jmx-prometheus-exporter
    hostname: exporter2
    ports:
      - 5557:5556
    environment:
      CONFIG_YML: /etc/jmx_exporter/config.yml
    volumes:
      - ./etc/jmx_exporter/config_kafka_broker_2.yml:/etc/jmx_exporter/config.yml
    depends_on:
      - kafka_broker_2